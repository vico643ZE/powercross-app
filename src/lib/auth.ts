import { PrismaAdapter } from '@auth/prisma-adapter'\nimport { compare, hash } from 'bcryptjs'\nimport NextAuth, { NextAuthOptions } from 'next-auth'\nimport CredentialsProvider from 'next-auth/providers/credentials'\nimport Google from 'next-auth/providers/google'\nimport GitHub from 'next-auth/providers/github'\nimport { prisma } from '@/lib/prisma'\n\nexport const authOptions: NextAuthOptions = {\n  adapter: PrismaAdapter(prisma),\n  session: { strategy: 'jwt' },\n  pages: {\n    signIn: '/auth/signin',\n    error: '/auth/error',\n  },\n  providers: [\n    CredentialsProvider({\n      name: 'Credentials',\n      credentials: {\n        email: { label: 'Email', type: 'email' },\n        password: { label: 'Password', type: 'password' },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials.password) return null\n        const user = await prisma.user.findUnique({ where: { email: credentials.email } })\n        if (!user?.passwordHash) return null\n        const valid = await compare(credentials.password, user.passwordHash)\n        if (!valid) return null\n        return { id: user.id, email: user.email ?? undefined, name: user.name ?? undefined }\n      },\n    }),\n    Google({\n      clientId: process.env.GOOGLE_CLIENT_ID ?? '',\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET ?? '',\n      allowDangerousEmailAccountLinking: true,\n    }),\n    GitHub({\n      clientId: process.env.GITHUB_ID ?? '',\n      clientSecret: process.env.GITHUB_SECRET ?? '',\n      allowDangerousEmailAccountLinking: true,\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.id = (user as any).id\n        token.role = (user as any).role ?? 'USER'\n      }\n      return token\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        (session.user as any).id = token.id\n        ;(session.user as any).role = token.role\n      }\n      return session\n    },\n  },\n}\n\nexport async function registerUser(email: string, password: string, name?: string) {\n  const existing = await prisma.user.findUnique({ where: { email } })\n  if (existing) throw new Error('User already exists')\n  const passwordHash = await hash(password, 10)\n  const user = await prisma.user.create({ data: { email, name, passwordHash } })\n  return user\n}\n